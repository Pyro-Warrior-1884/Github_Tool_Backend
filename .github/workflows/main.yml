name: Send code submission to backend

on:
  push:
    branches:
      - main

jobs:
  submit-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare folders
        run: mkdir -p encoded

      - name: Get first changed .py/.cpp/.java file
        id: detect_file
        run: |
          FILE=$(git diff --name-only HEAD^ HEAD | grep -E '\.py$|\.cpp$|\.java$' | head -n 1)
          echo "Changed file: $FILE"
          echo "$FILE" > encoded/filename.txt
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Encode the first changed file
        run: |
          FILENAME=$(cat encoded/filename.txt)
          if [ -z "$FILENAME" ] || [ ! -f "$FILENAME" ]; then
            echo "âš ï¸ No valid code file to encode. Exiting."
            exit 1
          fi
          base64 "$FILENAME" > encoded/code.txt

      - name: Send submission to backend
        run: |
          CODE=$(cat encoded/code.txt)
          FILENAME=$(cat encoded/filename.txt)

          JSON=$(jq -n \
            --arg name "${{ github.actor }}" \
            --arg commitCount "${{ github.event.commits && github.event.commits.length || 0 }}" \
            --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --arg filename "$FILENAME" \
            --arg content_b64 "$CODE" \
            '{name: $name, commitCount: $commitCount, timestamp: $timestamp, files: [{ filename: $filename, content_b64: $content_b64 }] }')

          echo "ðŸš€ Final Payload:"
          echo "$JSON" | jq

          curl -X POST https://github-tool-project.onrender.com/webhook \
            -H "Content-Type: application/json" \
            -d "$JSON"

